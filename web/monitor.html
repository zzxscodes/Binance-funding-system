<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤æ˜“ç³»ç»Ÿç›‘æ§é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0f1419;
            color: #e4e4e4;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: #1a1f2e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            color: #4fc3f7;
            font-size: 24px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-running {
            background: #2e7d32;
            color: white;
        }
        
        .status-stopped {
            background: #c62828;
            color: white;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: #1a1f2e;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #2a2f3e;
        }
        
        .card h2 {
            color: #4fc3f7;
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 1px solid #2a2f3e;
            padding-bottom: 10px;
        }
        
        .process-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #2a2f3e;
        }
        
        .process-item:last-child {
            border-bottom: none;
        }
        
        .process-name {
            font-weight: 500;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }
        
        .metric-label {
            color: #9e9e9e;
        }
        
        .metric-value {
            color: #4fc3f7;
            font-weight: bold;
        }
        
        .alert {
            background: #ff6b6b;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .refresh-btn {
            background: #4fc3f7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .refresh-btn:hover {
            background: #29b6f6;
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .timestamp {
            color: #9e9e9e;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .performance-card {
            background: #1a1f2e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #2a2f3e;
        }
        
        .performance-card h2 {
            color: #4fc3f7;
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 1px solid #2a2f3e;
            padding-bottom: 10px;
        }
        
        .performance-module {
            background: #0f1419;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 3px solid #4fc3f7;
        }
        
        .performance-module-name {
            color: #4fc3f7;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .performance-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 14px;
        }
        
        .performance-stat-label {
            color: #9e9e9e;
        }
        
        .performance-stat-value {
            color: #66bb6a;
            font-weight: bold;
        }
        
        .performance-operation {
            font-size: 12px;
            color: #9e9e9e;
            margin-left: 10px;
        }
        
        .account-card {
            background: #1a1f2e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #2a2f3e;
        }
        
        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2a2f3e;
        }
        
        .account-name {
            color: #4fc3f7;
            font-size: 20px;
            font-weight: bold;
        }
        
        .alerts-count {
            background: #ff6b6b;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 15px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid #2a2f3e;
        }
        
        .tab {
            padding: 8px 16px;
            cursor: pointer;
            color: #9e9e9e;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #4fc3f7;
            border-bottom-color: #4fc3f7;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .report-section {
            margin-bottom: 20px;
        }
        
        .report-section h3 {
            color: #4fc3f7;
            font-size: 16px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #2a2f3e;
        }
        
        .report-item {
            margin: 8px 0;
            padding: 8px;
            background: #0f1419;
            border-radius: 4px;
        }
        
        .report-item strong {
            color: #4fc3f7;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸš€ äº¤æ˜“ç³»ç»Ÿç›‘æ§é¢æ¿</h1>
            <div>
                <span class="status-badge" id="systemStatus">æ£€æŸ¥ä¸­...</span>
            </div>
        </header>
        
        <div class="grid">
            <div class="card">
                <h2>ç³»ç»Ÿè¿›ç¨‹çŠ¶æ€</h2>
                <div id="processesList"></div>
                <div class="timestamp" id="processesTimestamp"></div>
            </div>
            
            <div class="card">
                <h2>ç³»ç»Ÿä¿¡æ¯</h2>
                <div id="systemInfo"></div>
                <div class="timestamp" id="systemTimestamp"></div>
            </div>
        </div>
        
        <div id="performanceContainer"></div>
        
        <div id="accountsContainer"></div>
        
        <div class="auto-refresh">
            <button class="refresh-btn" onclick="refreshData()">æ‰‹åŠ¨åˆ·æ–°</button>
            <label>
                <input type="checkbox" id="autoRefresh" checked onchange="toggleAutoRefresh()">
                è‡ªåŠ¨åˆ·æ–° (5ç§’)
            </label>
        </div>
    </div>
    
    <!-- Load Chart.js before scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" onload="console.log('Chart.js loaded successfully')" onerror="console.error('Chart.js failed to load')"></script>
    
    <script>
        let autoRefreshInterval = null;
        const API_BASE = window.location.origin;
        
        // ç¡®ä¿ Chart.js åŠ è½½å®Œæˆåå†æ‰§è¡Œ
        function waitForChartJS(callback, maxWait = 10000) {
            if (typeof Chart !== 'undefined') {
                // Chart.js å·²ç»åŠ è½½ï¼Œç«‹å³æ‰§è¡Œå›è°ƒ
                callback();
                return;
            }
            
            const startTime = Date.now();
            const checkInterval = setInterval(() => {
                if (typeof Chart !== 'undefined') {
                    clearInterval(checkInterval);
                    callback();
                } else if (Date.now() - startTime > maxWait) {
                    clearInterval(checkInterval);
                    console.error('Chart.js failed to load within timeout');
                    // å³ä½¿è¶…æ—¶ä¹Ÿå°è¯•æ‰§è¡Œå›è°ƒï¼Œè®© loadEquityCurve å¤„ç†é”™è¯¯
                    callback();
                }
            }, 100);
        }
        
        async function fetchAPI(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                return null;
            }
        }
        
        function formatNumber(num) {
            if (num === null || num === undefined) return 'N/A';
            return new Intl.NumberFormat('zh-CN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }
        
        function formatBytes(bytes) {
            if (!bytes) return 'N/A';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let size = bytes;
            let unitIndex = 0;
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            return `${size.toFixed(2)} ${units[unitIndex]}`;
        }
        
        async function updateProcesses() {
            const data = await fetchAPI('/api/processes');
            if (!data) return;
            
            const container = document.getElementById('processesList');
            container.innerHTML = '';
            
            const processNames = {
                'event_coordinator': 'äº‹ä»¶åè°ƒå™¨',
                'data_layer': 'æ•°æ®å±‚',
                'strategy_process': 'ç­–ç•¥è¿›ç¨‹',
                'execution_process': 'æ‰§è¡Œè¿›ç¨‹',
                'monitoring_process': 'ç›‘æ§è¿›ç¨‹'
            };
            
            for (const [key, info] of Object.entries(data)) {
                const name = processNames[key] || key;
                const status = info.status === 'running' ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
                
                // å¯¹äºæ‰§è¡Œè¿›ç¨‹ï¼Œå¦‚æœæœ‰å¤šä¸ªè´¦æˆ·ï¼Œæ˜¾ç¤ºæ¯ä¸ªè´¦æˆ·çš„çŠ¶æ€
                if (key === 'execution_process' && info.accounts && Object.keys(info.accounts).length > 0) {
                    // æ˜¾ç¤ºæ€»è®¡æ•°
                    const summaryItem = document.createElement('div');
                    summaryItem.className = 'process-item';
                    summaryItem.innerHTML = `
                        <span class="process-name"><strong>${name}</strong> (${info.account_count || info.count} ä¸ªè´¦æˆ·)</span>
                        <span class="status-badge ${info.status === 'running' ? 'status-running' : 'status-stopped'}">
                            ${status}
                        </span>
                    `;
                    container.appendChild(summaryItem);
                    
                    // æ˜¾ç¤ºæ¯ä¸ªè´¦æˆ·çš„æ‰§è¡Œè¿›ç¨‹
                    for (const [accountId, accountProcs] of Object.entries(info.accounts)) {
                        const accountItem = document.createElement('div');
                        accountItem.className = 'process-item';
                        accountItem.style.paddingLeft = '20px';
                        accountItem.style.fontSize = '14px';
                        
                        const accountStatus = accountProcs.length > 0 ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
                        const accountCount = accountProcs.length > 0 ? `(${accountProcs.length})` : '';
                        
                        accountItem.innerHTML = `
                            <span class="process-name">  â””â”€ è´¦æˆ·: ${accountId}</span>
                            <span class="status-badge ${accountProcs.length > 0 ? 'status-running' : 'status-stopped'}">
                                ${accountStatus} ${accountCount}
                            </span>
                        `;
                        container.appendChild(accountItem);
                    }
                } else {
                    // å…¶ä»–è¿›ç¨‹æ­£å¸¸æ˜¾ç¤º
                    const item = document.createElement('div');
                    item.className = 'process-item';
                    
                    const count = info.count > 0 ? `(${info.count})` : '';
                    
                    item.innerHTML = `
                        <span class="process-name">${name}</span>
                        <span class="status-badge ${info.status === 'running' ? 'status-running' : 'status-stopped'}">
                            ${status} ${count}
                        </span>
                    `;
                    container.appendChild(item);
                }
            }
            
            document.getElementById('processesTimestamp').textContent = 
                `æ›´æ–°æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
        }
        
        async function updateSystemInfo() {
            const data = await fetchAPI('/api/system');
            if (!data) return;
            
            const container = document.getElementById('systemInfo');
            container.innerHTML = '';
            
            const info = [
                { label: 'å¹³å°', value: data.platform || 'N/A' },
                { label: 'Pythonç‰ˆæœ¬', value: data.python_version || 'N/A' },
                { label: 'CPUæ ¸å¿ƒæ•°', value: data.cpu_count || 'N/A' },
                { label: 'å†…å­˜ä½¿ç”¨ç‡', value: data.memory_percent ? `${data.memory_percent.toFixed(1)}%` : 'N/A' },
                { label: 'æ€»å†…å­˜', value: formatBytes(data.memory_total) },
                { label: 'å¯ç”¨å†…å­˜', value: formatBytes(data.memory_available) }
            ];
            
            info.forEach(item => {
                const metric = document.createElement('div');
                metric.className = 'metric';
                metric.innerHTML = `
                    <span class="metric-label">${item.label}:</span>
                    <span class="metric-value">${item.value}</span>
                `;
                container.appendChild(metric);
            });
            
            document.getElementById('systemTimestamp').textContent = 
                `æ›´æ–°æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
        }
        
        async function updatePerformance() {
            const data = await fetchAPI('/api/performance');
            if (!data || !data.enabled) {
                // å¦‚æœæ€§èƒ½ç›‘æ§æœªå¯ç”¨ï¼Œéšè—å®¹å™¨
                const container = document.getElementById('performanceContainer');
                if (container) {
                    container.innerHTML = '';
                }
                return;
            }
            
            const container = document.getElementById('performanceContainer');
            container.innerHTML = '';
            
            try {
                const card = document.createElement('div');
                card.className = 'performance-card';
                
                let html = '<h2>âš¡ æ€§èƒ½ç›‘æ§</h2>';
                
                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                if (data.statistics) {
                    const stats = data.statistics;
                    html += `
                        <div style="padding: 10px 0; border-bottom: 1px solid #2a2f3e; margin-bottom: 15px;">
                            <div class="metric">
                                <span class="metric-label">æ€»è½®æ¬¡:</span>
                                <span class="metric-value">${stats.total_rounds || 0}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">æ€»æµ‹é‡æ¬¡æ•°:</span>
                                <span class="metric-value">${stats.total_measurements || 0}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">è¿è¡Œæ—¶é—´:</span>
                                <span class="metric-value">${(stats.runtime_seconds || 0).toFixed(1)} ç§’</span>
                            </div>
                        </div>
                    `;
                }
                
                // æ˜¾ç¤ºå½“å‰è½®æ¬¡çš„æ¨¡å—æ€§èƒ½æ•°æ®
                if (data.current_round && data.current_round.modules) {
                    html += '<div style="margin-bottom: 15px;"><strong style="color: #4fc3f7;">å½“å‰è½®æ¬¡æ¨¡å—æ€§èƒ½:</strong></div>';
                    
                    for (const [moduleName, moduleData] of Object.entries(data.current_round.modules)) {
                        html += `
                            <div class="performance-module">
                                <div class="performance-module-name">${moduleName}</div>
                                <div class="performance-stat">
                                    <span class="performance-stat-label">å¹³å‡è€—æ—¶:</span>
                                    <span class="performance-stat-value">${(moduleData.avg_time * 1000).toFixed(2)} ms</span>
                                </div>
                                <div class="performance-stat">
                                    <span class="performance-stat-label">æ€»è€—æ—¶:</span>
                                    <span class="performance-stat-value">${(moduleData.total_time * 1000).toFixed(2)} ms</span>
                                </div>
                                <div class="performance-stat">
                                    <span class="performance-stat-label">è°ƒç”¨æ¬¡æ•°:</span>
                                    <span class="performance-stat-value">${moduleData.count}</span>
                                </div>
                                <div class="performance-stat">
                                    <span class="performance-stat-label">æœ€å°/æœ€å¤§:</span>
                                    <span class="performance-stat-value">${(moduleData.min_time * 1000).toFixed(2)} / ${(moduleData.max_time * 1000).toFixed(2)} ms</span>
                                </div>
                        `;
                        
                        // æ˜¾ç¤ºæ“ä½œçº§æ€§èƒ½æ•°æ®
                        if (moduleData.operations && Object.keys(moduleData.operations).length > 0) {
                            html += '<div style="margin-top: 8px; padding-left: 10px; border-left: 2px solid #66bb6a;">';
                            for (const [opName, opData] of Object.entries(moduleData.operations)) {
                                html += `
                                    <div style="font-size: 12px; color: #9e9e9e; margin: 4px 0;">
                                        ${opName}: avg=${(opData.avg * 1000).toFixed(2)}ms, count=${opData.count}
                                    </div>
                                `;
                            }
                            html += '</div>';
                        }
                        
                        html += '</div>';
                    }
                }
                
                // æ˜¾ç¤ºåˆ†ææŠ¥å‘Šæ‘˜è¦
                if (data.analysis && data.analysis.modules) {
                    html += '<div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #2a2f3e;"><strong style="color: #4fc3f7;">å†å²æ€§èƒ½åˆ†æ:</strong></div>';
                    
                    // æŒ‰æ€»è€—æ—¶æ’åº
                    const sortedModules = Object.entries(data.analysis.modules)
                        .sort((a, b) => (b[1].total_time || 0) - (a[1].total_time || 0))
                        .slice(0, 5); // æ˜¾ç¤ºå‰5ä¸ªè€—æ—¶æœ€é•¿çš„æ¨¡å—
                    
                    for (const [moduleName, moduleData] of sortedModules) {
                        const totalTime = moduleData.total_time || 0;
                        const avgTime = moduleData.avg_time_per_operation || 0;
                        const rounds = moduleData.rounds || 0;
                        
                        if (totalTime > 0) {
                            html += `
                                <div class="performance-module" style="border-left-color: #ff9800;">
                                    <div class="performance-module-name">${moduleName}</div>
                                    <div class="performance-stat">
                                        <span class="performance-stat-label">æ€»è€—æ—¶:</span>
                                        <span class="performance-stat-value">${(totalTime * 1000).toFixed(2)} ms</span>
                                    </div>
                                    <div class="performance-stat">
                                        <span class="performance-stat-label">å¹³å‡è€—æ—¶:</span>
                                        <span class="performance-stat-value">${(avgTime * 1000).toFixed(2)} ms</span>
                                    </div>
                                    <div class="performance-stat">
                                        <span class="performance-stat-label">è½®æ¬¡æ•°:</span>
                                        <span class="performance-stat-value">${rounds}</span>
                                    </div>
                                </div>
                            `;
                        }
                    }
                }
                
                card.innerHTML = html;
                container.appendChild(card);
                
            } catch (error) {
                console.error('Error rendering performance data:', error);
                container.innerHTML = '<div class="performance-card"><h2>âš¡ æ€§èƒ½ç›‘æ§</h2><div class="alert">åŠ è½½æ€§èƒ½æ•°æ®å¤±è´¥</div></div>';
            }
        }
        
        async function updateAccounts() {
            const data = await fetchAPI('/api/accounts');
            if (!data) return;
            
            const container = document.getElementById('accountsContainer');
            container.innerHTML = '';
            
            for (const [accountId, accountData] of Object.entries(data)) {
                if (accountData.error) {
                    const card = document.createElement('div');
                    card.className = 'account-card';
                    card.innerHTML = `
                        <div class="account-header">
                            <span class="account-name">${accountId}</span>
                        </div>
                        <div class="alert">é”™è¯¯: ${accountData.error}</div>
                    `;
                    container.appendChild(card);
                    continue;
                }
                
                const metrics = accountData.account_metrics || {};
                const exposure = accountData.exposure || {};
                const deviation = accountData.deviation || {};
                const alerts = accountData.alerts || [];
                
                const card = document.createElement('div');
                card.className = 'account-card';
                
                let alertsHtml = '';
                if (alerts.length > 0) {
                    alertsHtml = '<div class="alert">' + alerts.map(a => a.message).join('<br>') + '</div>';
                }
                
                card.innerHTML = `
                    <div class="account-header">
                        <span class="account-name">è´¦æˆ·: ${accountId}</span>
                        ${alerts.length > 0 ? `<span class="alerts-count">${alerts.length} ä¸ªå‘Šè­¦</span>` : ''}
                    </div>
                    ${alertsHtml}
                    
                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('${accountId}', 'metrics')">è´¦æˆ·æŒ‡æ ‡</div>
                        <div class="tab" onclick="switchTab('${accountId}', 'equity')">Equity Curve</div>
                        <div class="tab" onclick="switchTab('${accountId}', 'report')">ç­–ç•¥æŠ¥å‘Š</div>
                    </div>
                    
                    <div id="${accountId}-metrics" class="tab-content active">
                        <div class="metric">
                            <span class="metric-label">æ€»ä½™é¢:</span>
                            <span class="metric-value">${formatNumber(metrics.total_wallet_balance)} USDT</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">å¯ç”¨ä½™é¢:</span>
                            <span class="metric-value">${formatNumber(metrics.available_balance)} USDT</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">æœªå®ç°ç›ˆäº:</span>
                            <span class="metric-value">${formatNumber(metrics.total_unrealized_pnl)} USDT</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">æŒä»“æ•°é‡:</span>
                            <span class="metric-value">${metrics.open_positions_count || 0}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">æŒä»“ä»·å€¼:</span>
                            <span class="metric-value">${formatNumber(metrics.position_value)} USDT</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">å‡€æ•å£:</span>
                            <span class="metric-value">${formatNumber(exposure.net_exposure)} USDT</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">æ€»æ•å£:</span>
                            <span class="metric-value">${formatNumber(exposure.total_exposure)} USDT</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">å¹³å‡åå·®:</span>
                            <span class="metric-value">${formatNumber(deviation.avg_deviation)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">æœ€å¤§åå·®:</span>
                            <span class="metric-value">${formatNumber(deviation.max_deviation)}</span>
                        </div>
                    </div>
                    
                    <div id="${accountId}-equity" class="tab-content">
                        <div class="chart-container">
                            <canvas id="${accountId}-equity-chart"></canvas>
                        </div>
                        <div id="${accountId}-equity-summary"></div>
                    </div>
                    
                    <div id="${accountId}-report" class="tab-content">
                        <div id="${accountId}-report-content">åŠ è½½ä¸­...</div>
                    </div>
                    
                    <div class="timestamp">æ›´æ–°æ—¶é—´: ${accountData.timestamp ? new Date(accountData.timestamp).toLocaleString('zh-CN') : 'N/A'}</div>
                `;
                container.appendChild(card);
                
                // åŠ è½½Equity Curveå’Œç­–ç•¥æŠ¥å‘Šï¼ˆç­‰å¾… Chart.js åŠ è½½å®Œæˆï¼‰
                waitForChartJS(() => {
                    loadEquityCurve(accountId);
                });
                loadStrategyReport(accountId);
            }
        }
        
        async function updateSystemStatus() {
            const data = await fetchAPI('/api/status');
            if (!data) return;
            
            const statusBadge = document.getElementById('systemStatus');
            if (data.status === 'running') {
                statusBadge.className = 'status-badge status-running';
                statusBadge.textContent = 'ç³»ç»Ÿè¿è¡Œä¸­';
            } else {
                statusBadge.className = 'status-badge status-stopped';
                statusBadge.textContent = 'ç³»ç»Ÿå·²åœæ­¢';
            }
        }
        
        async function refreshData() {
            await Promise.all([
                updateSystemStatus(),
                updateProcesses(),
                updateSystemInfo(),
                updatePerformance(),
                updateAccounts()
            ]);
        }
        
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            if (checkbox.checked) {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }
                autoRefreshInterval = setInterval(refreshData, 5000);
                refreshData();
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }
        
        const equityCharts = {};
        
        function switchTab(accountId, tabName) {
            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            const tabs = document.querySelectorAll(`#accountsContainer .account-card:has([id="${accountId}-metrics"]) .tab`);
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            const contents = document.querySelectorAll(`#accountsContainer .account-card:has([id="${accountId}-metrics"]) .tab-content`);
            contents.forEach(content => content.classList.remove('active'));
            document.getElementById(`${accountId}-${tabName}`).classList.add('active');
        }
        
        async function loadEquityCurve(accountId) {
            try {
                const data = await fetchAPI(`/api/equity-curve/${accountId}`);
                if (!data || !data.data || data.data.length === 0) {
                    document.getElementById(`${accountId}-equity`).innerHTML = 
                        '<div style="padding: 20px; text-align: center; color: #9e9e9e;">æš‚æ— Equity Curveæ•°æ®</div>';
                    return;
                }
                
                const chartData = data.data;
                const summary = data.summary || {};
                
                // å‡†å¤‡å›¾è¡¨æ•°æ®
                const labels = chartData.map(d => {
                    try {
                        return new Date(d.timestamp).toLocaleString('zh-CN');
                    } catch (e) {
                        return d.timestamp || '';
                    }
                });
                const equityValues = chartData.map(d => parseFloat(d.equity) || 0);
                const returnValues = chartData.map(d => parseFloat(d.return_pct) || 0);
                
                // åˆ›å»ºæˆ–æ›´æ–°å›¾è¡¨
                const canvas = document.getElementById(`${accountId}-equity-chart`);
                if (!canvas) {
                    console.error(`Canvas element not found for ${accountId}-equity-chart`);
                    document.getElementById(`${accountId}-equity`).innerHTML = 
                        '<div style="padding: 20px; text-align: center; color: #ff6b6b;">å›¾è¡¨å…ƒç´ æœªæ‰¾åˆ°</div>';
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error(`Failed to get 2d context for ${accountId}-equity-chart`);
                    document.getElementById(`${accountId}-equity`).innerHTML = 
                        '<div style="padding: 20px; text-align: center; color: #ff6b6b;">æ— æ³•åˆ›å»ºå›¾è¡¨ä¸Šä¸‹æ–‡</div>';
                    return;
                }
                
                if (equityCharts[accountId]) {
                    equityCharts[accountId].destroy();
                }
                
                // æ£€æŸ¥ Chart æ˜¯å¦å¯ç”¨ï¼Œå¦‚æœæœªåŠ è½½åˆ™ç­‰å¾…
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js not loaded yet, waiting...');
                    // ç­‰å¾… Chart.js åŠ è½½ï¼ˆæœ€å¤šç­‰å¾… 5 ç§’ï¼‰
                    let retries = 0;
                    const maxRetries = 50; // 5ç§’
                    const checkChart = setInterval(() => {
                        retries++;
                        if (typeof Chart !== 'undefined') {
                            clearInterval(checkChart);
                            // Chart.js å·²åŠ è½½ï¼Œé‡æ–°è°ƒç”¨å‡½æ•°
                            console.log('Chart.js loaded, retrying...');
                            loadEquityCurve(accountId);
                        } else if (retries >= maxRetries) {
                            clearInterval(checkChart);
                            console.error('Chart.js failed to load after 5 seconds');
                            const equityDiv = document.getElementById(`${accountId}-equity`);
                            if (equityDiv) {
                                equityDiv.innerHTML = 
                                    '<div style="padding: 20px; text-align: center; color: #ff6b6b;">Chart.js åŠ è½½è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
                            }
                        }
                    }, 100);
                    return;
                }
                
                equityCharts[accountId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'å‡€å€¼ (USDT)',
                            data: equityValues,
                            borderColor: '#4fc3f7',
                            backgroundColor: 'rgba(79, 195, 247, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        }, {
                            label: 'æ”¶ç›Šç‡ (%)',
                            data: returnValues,
                            borderColor: '#66bb6a',
                            backgroundColor: 'rgba(102, 187, 106, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#e4e4e4'
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#9e9e9e',
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: {
                                    color: '#2a2f3e'
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                ticks: {
                                    color: '#4fc3f7'
                                },
                                grid: {
                                    color: '#2a2f3e'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                ticks: {
                                    color: '#66bb6a'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
                
                // æ·»åŠ æ‘˜è¦ä¿¡æ¯ï¼ˆåœ¨å›¾è¡¨å®¹å™¨å¤–éƒ¨ï¼‰
                if (summary.initial_equity !== undefined) {
                    const summaryContainer = document.getElementById(`${accountId}-equity-summary`);
                    if (summaryContainer) {
                        summaryContainer.innerHTML = `
                            <div style="margin-top: 15px; padding: 10px; background: #0f1419; border-radius: 4px;">
                                <div class="metric">
                                    <span class="metric-label">åˆå§‹å‡€å€¼:</span>
                                    <span class="metric-value">${formatNumber(summary.initial_equity)} USDT</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">å½“å‰å‡€å€¼:</span>
                                    <span class="metric-value">${formatNumber(summary.current_equity)} USDT</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">æ€»æ”¶ç›Š:</span>
                                    <span class="metric-value">${formatNumber(summary.total_return)} USDT (${formatNumber(summary.total_return_pct)}%)</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">æœ€å¤§å›æ’¤:</span>
                                    <span class="metric-value">${formatNumber(summary.max_drawdown)} USDT (${formatNumber(summary.max_drawdown_pct)}%)</span>
                                </div>
                            </div>
                        `;
                    } else {
                        // å¦‚æœæ‘˜è¦å®¹å™¨ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
                        const equityDiv = document.getElementById(`${accountId}-equity`);
                        if (equityDiv) {
                            const summaryDiv = document.createElement('div');
                            summaryDiv.id = `${accountId}-equity-summary`;
                            summaryDiv.innerHTML = `
                                <div style="margin-top: 15px; padding: 10px; background: #0f1419; border-radius: 4px;">
                                    <div class="metric">
                                        <span class="metric-label">åˆå§‹å‡€å€¼:</span>
                                        <span class="metric-value">${formatNumber(summary.initial_equity)} USDT</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">å½“å‰å‡€å€¼:</span>
                                        <span class="metric-value">${formatNumber(summary.current_equity)} USDT</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">æ€»æ”¶ç›Š:</span>
                                        <span class="metric-value">${formatNumber(summary.total_return)} USDT (${formatNumber(summary.total_return_pct)}%)</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-label">æœ€å¤§å›æ’¤:</span>
                                        <span class="metric-value">${formatNumber(summary.max_drawdown)} USDT (${formatNumber(summary.max_drawdown_pct)}%)</span>
                                    </div>
                                </div>
                            `;
                            equityDiv.appendChild(summaryDiv);
                        }
                    }
                }
                
            } catch (error) {
                console.error(`Error loading equity curve for ${accountId}:`, error);
                console.error('Error details:', error.message, error.stack);
                const errorDiv = document.getElementById(`${accountId}-equity`);
                if (errorDiv) {
                    errorDiv.innerHTML = 
                        `<div style="padding: 20px; text-align: center; color: #ff6b6b;">
                            åŠ è½½Equity Curveå¤±è´¥<br>
                            <small style="color: #9e9e9e; font-size: 12px;">${error.message || 'æœªçŸ¥é”™è¯¯'}</small>
                         </div>`;
                }
            }
        }
        
        async function loadStrategyReport(accountId) {
            try {
                const report = await fetchAPI(`/api/strategy-report/${accountId}`);
                if (!report || Object.keys(report).length === 0) {
                    document.getElementById(`${accountId}-report-content`).innerHTML = 
                        '<div style="padding: 20px; text-align: center; color: #9e9e9e;">æš‚æ— ç­–ç•¥æŠ¥å‘Šæ•°æ®</div>';
                    return;
                }
                
                let html = '';
                
                // å¸ç§åˆ—è¡¨ï¼ˆåªæ˜¾ç¤ºæ•°å€¼ï¼Œä¸æ˜¾ç¤ºæè¿°ï¼‰
                if (report.coin_selection && report.coin_selection.symbols) {
                    html += '<div class="report-section">';
                    html += '<h3>å¸ç§åˆ—è¡¨</h3>';
                    html += `<div class="report-item"><strong>äº¤æ˜“å¯¹æ•°é‡:</strong> ${report.coin_selection.symbols_count || 0}</div>`;
                    html += `<div class="report-item"><strong>äº¤æ˜“å¯¹:</strong> ${report.coin_selection.symbols.join(', ') || 'N/A'}</div>`;
                    html += '</div>';
                }
                
                // èµ„é‡‘è´¹ç‡ç»“æ„ï¼ˆæ˜¾ç¤ºæ‰€æœ‰é€‰ä¸­äº¤æ˜“å¯¹ï¼ŒåŒ…æ‹¬æ— æ•°æ®çš„æƒ…å†µï¼‰
                if (report.funding_rate_structure && Object.keys(report.funding_rate_structure).length > 0) {
                    html += '<div class="report-section">';
                    html += '<h3>èµ„é‡‘è´¹ç‡ç»“æ„</h3>';
                    for (const [symbol, fr] of Object.entries(report.funding_rate_structure)) {
                        html += `<div class="report-item">`;
                        if (fr.status === 'ok' && fr.data_points > 0) {
                            html += `<strong>${symbol}:</strong> å¹³å‡è´¹ç‡=${(fr.mean_rate * 100).toFixed(4)}%, `;
                            html += `æœ€æ–°è´¹ç‡=${(fr.latest_rate * 100).toFixed(4)}%, `;
                            html += `æ ‡å‡†å·®=${(fr.std_rate * 100).toFixed(4)}%, `;
                            html += `æ•°æ®ç‚¹æ•°=${fr.data_points}`;
                        } else {
                            html += `<strong>${symbol}:</strong> <span style="color: #9e9e9e;">${fr.message || 'æ— æ•°æ®'}</span>`;
                        }
                        html += `</div>`;
                    }
                    html += '</div>';
                }
                
                // å¼€ä»“æ—¶é—´ç‚¹
                if (report.position_openings && report.position_openings.length > 0) {
                    html += '<div class="report-section">';
                    html += '<h3>å¼€ä»“æ—¶é—´ç‚¹</h3>';
                    html += `<div class="report-item"><strong>å¼€ä»“æ¬¡æ•°:</strong> ${report.position_openings.length}</div>`;
                    report.position_openings.slice(0, 10).forEach(opening => {
                        const time = new Date(opening.timestamp).toLocaleString('zh-CN');
                        html += `<div class="report-item">${opening.symbol}: ${opening.position_amt > 0 ? 'åšå¤š' : 'åšç©º'} ${Math.abs(opening.position_amt)} @ ${opening.entry_price} (${time})</div>`;
                    });
                    if (report.position_openings.length > 10) {
                        html += `<div class="report-item">...è¿˜æœ‰ ${report.position_openings.length - 10} æ¡è®°å½•</div>`;
                    }
                    html += '</div>';
                }
                
                // ç­–ç•¥ç£¨æŸåˆ†æï¼ˆåªæ˜¾ç¤ºæ•°å€¼ï¼‰
                if (report.strategy_wear) {
                    html += '<div class="report-section">';
                    html += '<h3>ç­–ç•¥ç£¨æŸåˆ†æ</h3>';
                    const wear = report.strategy_wear;
                    html += `<div class="report-item"><strong>æ‰‹ç»­è´¹:</strong> ${formatNumber(wear.total_fees || 0)} USDT</div>`;
                    html += `<div class="report-item"><strong>æ»‘ç‚¹:</strong> ${formatNumber(wear.slippage || 0)} USDT</div>`;
                    html += `<div class="report-item"><strong>èµ„é‡‘è´¹ç‡æˆæœ¬:</strong> ${formatNumber(wear.funding_fees || 0)} USDT</div>`;
                    html += `<div class="report-item"><strong>æ€»ç£¨æŸ:</strong> ${formatNumber(wear.total_wear || 0)} USDT (${formatNumber(wear.wear_pct || 0)}%)</div>`;
                    html += `<div class="report-item"><strong>äº¤æ˜“æ¬¡æ•°:</strong> ${wear.total_trades || 0}</div>`;
                    html += '</div>';
                }
                
                document.getElementById(`${accountId}-report-content`).innerHTML = html || 
                    '<div style="padding: 20px; text-align: center; color: #9e9e9e;">æš‚æ— ç­–ç•¥æŠ¥å‘Šæ•°æ®</div>';
                
            } catch (error) {
                console.error(`Error loading strategy report for ${accountId}:`, error);
                document.getElementById(`${accountId}-report-content`).innerHTML = 
                    '<div style="padding: 20px; text-align: center; color: #ff6b6b;">åŠ è½½ç­–ç•¥æŠ¥å‘Šå¤±è´¥</div>';
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            refreshData();
            toggleAutoRefresh();
        });
    </script>
</body>
</html>
